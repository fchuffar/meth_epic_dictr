---
title: "EPI2R - WP4"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=TRUE, results="verbatim")
```


# Methepic_map

We call the the `build_dictionary.R` script to index Epic probes according to Epic annotations

```{r, results="hide"}
source("build_dictionary.R")
dim(pf)
```

# Xu et al. 2020 probes

We launch probes defined by Xu et al.

*Blood DNA Methylation and Breast Cancer: A Prospective Case-Cohort Analysis in the Sister Study*
Zongli Xu, Dale P Sandler, Jack A Taylor
**J Natl Cancer Inst**, 2020 Jan 1;112(1):87-94.  doi: 10.1093/jnci/djz065.
PMID: 30989176


```{r}
xu = openxlsx::read.xlsx("~/projects/cancair/doc/Xu_2020_JNCI_CpG_list.xlsx",colNames=TRUE, rowNames=TRUE)
head(xu)
dim(xu)

probes = rownames(xu)[rownames(xu) %in% rownames(pf)]
length(probes)

pf[probes,]

# Relative postion acc. to CGI
table(pf[probes,]$Relation_to_Island)
table(pf$Relation_to_Island)
prop.table(table(pf[probes,]$Relation_to_Island))
prop.table(table(pf$Relation_to_Island)         )

pf[probes,]$UCSC_RefGene_Name      
pf[probes,]$UCSC_RefGene_Group     

```

We convert probes into region of interest (ROI)

```{r}
feat = pf[probes, c(1, 2)]
feat$end = feat[,2] + 1
head(feat)
dim(feat)
roi = lapply(unique(feat[,1]), function(chr) {
  d = feat[feat[,1]==chr,]
  dim(d)
  i = intervals::Intervals(c(d[,2], d[,3]), type="Z")
  c = intervals::close_intervals(intervals::reduce(i))
  # enlarge your fat feat
  l = 1000
  # c = intervals::close_intervals( intervals::contract( intervals::reduce(intervals::expand(i, l)), l) )
  c = intervals::close_intervals(intervals::reduce(intervals::expand(i, l)))
  dim(c)
  df = data.frame(chr, c[,1], c[,2], ".", c[,2]-c[,1], "+")
  return(df)
})
roi = do.call(rbind, roi)
head(roi)
dim(roi)
roi[,5]
```

Now, we get EPIC probes in ROI

```{r}
# divide pf into chrs_indexed_methpf a list of 24 sub pf (1 by chr)
table(pf[,1])
# meth pf
pf_chr_colname = "chr"
pf_pos_colname = "pos"
pf_orig = pf
pf_orig = pf_orig[pf_orig[,pf_pos_colname]>0,]    
pf_orig = pf_orig[order(pf_orig[[pf_chr_colname]],pf_orig[[pf_pos_colname]]), ]
## index meth probes by chr
chrs = unique(pf_orig[[pf_chr_colname]])
chrs_indexed_methpf = lapply(chrs, function(chr) {
  # print(chr)
  idx = rownames(pf_orig)[!is.na(pf_orig[[pf_chr_colname]]) & pf_orig[[pf_chr_colname]]==chr]  
  ret = pf_orig[idx,]
  return(ret)
})
names(chrs_indexed_methpf) = chrs


# epimedtools::monitored_apply is from https://github.com/fchuffar/epimedtools devtools::install_github("fchuffar/epimedtools")
roi_indexed_probes = epimedtools::monitored_apply(roi, 1, function(feat) {
  # feat = fat_feat[3,]
  # print(feat)
  chr = feat[[1]]
  len = as.numeric(feat[[5]])
  meth_platform = chrs_indexed_methpf[[chr]]
  ret = dmprocr::get_probe_names(feat, meth_platform, pf_chr_colname, pf_pos_colname, 0, len) 
  # meth_platform[ret,1:3]
  # feat
  return(ret)
})

table(sapply(roi_indexed_probes, length))
length(unlist(roi_indexed_probes))
length(unique(unlist(roi_indexed_probes)))

probes2 =  unique(unlist(roi_indexed_probes))

# foo = pf_orig[probes,2][-1] - pf_orig[probes,2][-length(probes)]
# names(foo) = probes[-1]
# foo[names(foo)[foo>0& foo<2000]]
# bar = names(foo[names(foo)[foo>0& foo<2000]])
# xu[bar,]


saveRDS(probes2, "extended_probes_xu.rds")

```

`probes2` is the new set of probes

TODO : 

rlm_out = ...(probes)

rlm_out$pv_raw
rlm_out$cpg

chrs = unique(pf[probes2,]$chr)
max_pos = sapply(chrs, function(chr) {
  meth_platform = chrs_indexed_methpf[[chr]]
  max(meth_platform[intersect(rownames(meth_platform),probes2),]$pos)
})
foo = as.numeric(cumsum(as.numeric(max_pos)))
names(foo) = chrs
foo = foo - foo[1]
plot(pf[probes2,]$pos)
plot(pf[probes2,]$pos + foo[pf[probes2,]$chr])
plot(pf[probes2,]$pos + foo[pf[probes2,]$chr], pf$pv_raw, main="Manhatan plot", pch=".")



# Session Information

```{r results="verbatim"}
sessionInfo()
date()
```



























